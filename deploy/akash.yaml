# Akash SDL for Ironclaw AI Agent
# ============================================================
#
# This SDL deploys the Ironclaw agent on Akash Network.
#
# Docker images are automatically built and pushed to GitHub Container Registry
# via the .github/workflows/docker.yml workflow.
#
# IMPORTANT: Akash requires EXPLICIT version tags (NOT :latest)
# Available tags after CI/CD builds:
#   - ghcr.io/toxmon/ironclaw:v0.1.0       (version releases - USE THIS)
#   - ghcr.io/toxmon/ironclaw:sha-abc1234  (commit SHA for specific builds)
#
# Before first deployment:
# 1. Push code to main branch OR create a version tag (v0.1.0)
# 2. Wait for GitHub Actions to build and publish the image
# 3. Verify image exists: https://github.com/ToXMon/ironclaw/pkgs/container/ironclaw
# 4. Set up external PostgreSQL database (Neon, Supabase, Railway, etc.)
# 5. Replace CHANGE_ME values with your actual credentials
#
# Deploy via Akash Console:
#   https://console.akash.network
#
# ============================================================

version: "2.0"

services:
  # Main Ironclaw Application
  ironclaw:
    # Docker image - automatically built via GitHub Actions
    # IMPORTANT: Must use explicit version tag (Akash rejects :latest)
    # Update this tag when new versions are released
    image: ghcr.io/toxmon/ironclaw:v0.1.0
    
    env:
      # === Database Configuration ===
      # Use an external PostgreSQL database with pgvector extension
      # Options: Neon, Supabase, Railway, AWS RDS, Google Cloud SQL, etc.
      - "DATABASE_URL=postgres://ironclaw:CHANGE_ME@your-db-host:5432/ironclaw"
      - "DATABASE_POOL_SIZE=10"
      
      # === NEAR AI Configuration ===
      # Get your session token from: https://cloud.near.ai
      - "NEARAI_SESSION_TOKEN=CHANGE_ME"
      - "NEARAI_MODEL=claude-3-5-sonnet-20241022"
      - "NEARAI_BASE_URL=https://cloud-api.near.ai"
      - "NEARAI_AUTH_URL=https://private.near.ai"
      - "NEARAI_API_MODE=chat_completions"
      
      # === Agent Configuration ===
      - "AGENT_NAME=ironclaw"
      - "CLI_ENABLED=false"
      
      # === Web Gateway (HTTP API) ===
      - "GATEWAY_ENABLED=true"
      - "GATEWAY_HOST=0.0.0.0"
      - "GATEWAY_PORT=3000"
      - "GATEWAY_AUTH_TOKEN=CHANGE_ME"
      
      # === Optional: Disable features for initial deploy ===
      - "SANDBOX_ENABLED=false"
      - "HEARTBEAT_ENABLED=false"
      - "EMBEDDING_ENABLED=false"
      
      # === Logging ===
      - "RUST_LOG=ironclaw=info"
    
    expose:
      - port: 3000
        as: 80
        to:
          - global: true
        http_options:
          max_body_size: 10485760    # 10MB max request body
          read_timeout: 60000        # 60s read timeout
          send_timeout: 60000        # 60s send timeout
          next_tries: 3
          next_cases:
            - error
            - timeout
            - "500"
            - "502"
            - "503"

profiles:
  compute:
    ironclaw:
      resources:
        cpu:
          units: 1.0               # 1 CPU core
        memory:
          size: 2Gi                # 2GB RAM - Rust apps are memory efficient
        storage:
          size: 5Gi                # 5GB for logs and temp files
  
  placement:
    dcloud:
      # Optional: Filter by region
      # attributes:
      #   region: us-west
      
      # Optional: Require audited providers
      # signedBy:
      #   anyOf:
      #     - akash1365yvmc4s7awdyj3n2sav7xfx76adc6dnmlx63
      
      pricing:
        ironclaw:
          denom: uakt
          amount: 1500             # ~0.0015 AKT/block (~65 AKT/month)

deployment:
  ironclaw:
    dcloud:
      profile: ironclaw
      count: 1                    # Single instance - scale as needed
