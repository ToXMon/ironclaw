# Akash SDL for Ironclaw AI Agent - Full Stack (with PostgreSQL)
# ============================================================
# 
# This SDL deploys the Ironclaw agent with an embedded PostgreSQL database.
# Use this for self-contained deployments without external database dependency.
#
# IMPORTANT: Before deploying:
# 1. Build and push your Docker image to a registry
# 2. Replace CHANGE_ME values with your actual credentials
# 3. Note: Database uses persistent storage (beta2 class)
#
# Build & Push:
#   docker build --platform linux/amd64 -t yourregistry/ironclaw:v1.0.0 .
#   docker push yourregistry/ironclaw:v1.0.0
#
# Deploy via Akash Console:
#   https://console.akash.network
#
# ============================================================

version: "2.0"

services:
  # PostgreSQL Database with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    env:
      - "POSTGRES_DB=ironclaw"
      - "POSTGRES_USER=ironclaw"
      - "POSTGRES_PASSWORD=CHANGE_ME_STRONG_PASSWORD"
    expose:
      - port: 5432
        to:
          - service: ironclaw
    params:
      storage:
        pgdata:
          mount: /var/lib/postgresql/data
          readOnly: false

  # Main Ironclaw Application
  ironclaw:
    # IMPORTANT: Replace with your actual registry path and version tag
    image: yourregistry/ironclaw:v1.0.0
    
    # Database connects to local postgres service
    dependencies:
      - service: postgres
    
    env:
      # === Database Configuration ===
      - "DATABASE_URL=postgres://ironclaw:CHANGE_ME_STRONG_PASSWORD@postgres:5432/ironclaw"
      - "DATABASE_POOL_SIZE=10"
      
      # === NEAR AI Configuration ===
      - "NEARAI_SESSION_TOKEN=CHANGE_ME"
      - "NEARAI_MODEL=claude-3-5-sonnet-20241022"
      - "NEARAI_BASE_URL=https://cloud-api.near.ai"
      - "NEARAI_AUTH_URL=https://private.near.ai"
      - "NEARAI_API_MODE=chat_completions"
      
      # === Agent Configuration ===
      - "AGENT_NAME=ironclaw"
      - "CLI_ENABLED=false"
      
      # === Web Gateway (HTTP API) ===
      - "GATEWAY_ENABLED=true"
      - "GATEWAY_HOST=0.0.0.0"
      - "GATEWAY_PORT=3000"
      - "GATEWAY_AUTH_TOKEN=CHANGE_ME"
      
      # === Optional: Disable features for initial deploy ===
      - "SANDBOX_ENABLED=false"
      - "HEARTBEAT_ENABLED=false"
      - "EMBEDDING_ENABLED=false"
      
      # === Logging ===
      - "RUST_LOG=ironclaw=info"
    
    expose:
      - port: 3000
        as: 80
        to:
          - global: true
        http_options:
          max_body_size: 10485760
          read_timeout: 60000
          send_timeout: 60000
          next_tries: 3
          next_cases:
            - error
            - timeout
            - "500"
            - "502"
            - "503"

profiles:
  compute:
    postgres:
      resources:
        cpu:
          units: 0.5
        memory:
          size: 1Gi
        storage:
          - name: default
            size: 1Gi
          - name: pgdata
            size: 20Gi
            attributes:
              persistent: true
              class: beta2            # SSD storage for database
  
    ironclaw:
      resources:
        cpu:
          units: 1.0
        memory:
          size: 2Gi
        storage:
          size: 5Gi
  
  placement:
    dcloud:
      pricing:
        postgres:
          denom: uakt
          amount: 2000             # Higher for persistent storage
        ironclaw:
          denom: uakt
          amount: 1500

deployment:
  postgres:
    dcloud:
      profile: postgres
      count: 1                    # Single DB instance
  
  ironclaw:
    dcloud:
      profile: ironclaw
      count: 1
